trigger:
  branches:
    include:
    - refs/heads/master
    - refs/tags/*

jobs:
  - job: run_rustfmt
    displayName: "Run rust fmt"
    pool:
        vmImage: ubuntu-16.04
    steps:
    - template: ci/azure-install-rust.yml
      parameters:
        rust_version: stable
    - script: |
        rustup component add rustfmt
      displayName: Install rustfmt
    - script: |
        cargo fmt --all -- --check
      displayName: Check formatting
  - job: run_cargo_test
    displayName: "cargo test"
    dependsOn:
      - run_rustfmt
    strategy:
      matrix:
        Linux:
          vmImage: ubuntu-16.04
        MacOS:
          vmImage: macOS-10.13
        Windows:
          vmImage: vs2017-win2016
    pool:
      vmImage: $(vmImage)
    steps:
    - template: ci/azure-install-rust.yml
      parameters:
        rust_version: stable
    - script: cargo test
      displayName: Cargo test
  - job: create_binaries
    displayName: "Create release binaries"
    dependsOn:
      - run_cargo_test
    strategy:
      matrix:
        Linux:
          vmImage: ubuntu-16.04
          distName: "dist_ubuntu"
        MacOS:
          vmImage: macOS-10.13
          distName: "dist_darwin"
        Windows:
          vmImage: vs2017-win2016
          distName: "dist_windows"
    pool:
      vmImage: $(vmImage)
    steps:
    - template: ci/azure-install-rust.yml
      parameters:
        rust_version: stable
    - script: cargo build --release
      displayName: cargo build release
    - template: ci/azure-publish-artifact.yml
      parameters:
        name: $(distName)
